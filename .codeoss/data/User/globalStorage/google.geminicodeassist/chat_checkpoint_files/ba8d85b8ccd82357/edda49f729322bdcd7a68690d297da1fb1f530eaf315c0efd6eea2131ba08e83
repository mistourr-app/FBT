<!-- index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Material Design CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Material Design Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- App Stylesheet -->
    <link rel="stylesheet" href="styles.css">
    <title>Family Budget Tracker</title>
</head>
<body class="mdc-typography">

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 class="mdc-typography--headline4">Budget Tracker</h1>
        <a href="/categories.html" class="mdc-button">
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label">Manage Categories</span>
        </a>
    </div>


    <!-- Summary Section -->
    <div class="summary">
        <div>
            <h3>Total Income</h3>
            <span id="total-income" class="amount">$0.00</span>
        </div>
        <div>
            <h3>Total Expenses</h3>
            <span id="total-expenses" class="amount">$0.00</span>
        </div>
        <div>
            <h3>Balance</h3>
            <span id="balance" class="amount">$0.00</span>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filters">
        <div class="mdc-select mdc-select--outlined" id="year-filter-mdc">
            <div class="mdc-select__anchor" role="button" aria-haspopup="listbox" aria-expanded="false">
                <span class="mdc-notched-outline"><span class="mdc-notched-outline__leading"></span><span class="mdc-notched-outline__notch"><span id="year-label" class="mdc-floating-label">Year</span></span><span class="mdc-notched-outline__trailing"></span></span>
                <span class="mdc-select__selected-text-container"><span id="year-selected-text" class="mdc-select__selected-text"></span></span>
                <span class="mdc-select__dropdown-icon"><svg class="mdc-select__dropdown-icon-graphic" viewBox="7 10 10 5" focusable="false"><polygon class="mdc-select__dropdown-icon-inactive" stroke="none" fill-rule="evenodd" points="7 10 12 15 17 10"></polygon><polygon class="mdc-select__dropdown-icon-active" stroke="none" fill-rule="evenodd" points="7 15 12 10 17 15"></polygon></svg></span>
            </div>
            <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                <ul class="mdc-list" id="year-list" role="listbox"></ul>
            </div>
        </div>
        <div class="mdc-select mdc-select--outlined" id="month-filter-mdc">
            <div class="mdc-select__anchor" role="button" aria-haspopup="listbox" aria-expanded="false">
                <span class="mdc-notched-outline"><span class="mdc-notched-outline__leading"></span><span class="mdc-notched-outline__notch"><span id="month-label" class="mdc-floating-label">Month</span></span><span class="mdc-notched-outline__trailing"></span></span>
                <span class="mdc-select__selected-text-container"><span id="month-selected-text" class="mdc-select__selected-text"></span></span>
                <span class="mdc-select__dropdown-icon"><svg class="mdc-select__dropdown-icon-graphic" viewBox="7 10 10 5" focusable="false"><polygon class="mdc-select__dropdown-icon-inactive" stroke="none" fill-rule="evenodd" points="7 10 12 15 17 10"></polygon><polygon class="mdc-select__dropdown-icon-active" stroke="none" fill-rule="evenodd" points="7 15 12 10 17 15"></polygon></svg></span>
            </div>
            <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                <ul class="mdc-list" id="month-list" role="listbox"></ul>
            </div>
        </div>
        <!-- Hidden original selects for logic -->
        <select id="month-filter" style="display: none;"></select>
        <select id="year-filter" style="display: none;"></select>
    </div>

    <!-- Forms Section -->
    <div class="forms">
        <div class="form-container">
            <h2 class="mdc-typography--headline6">Add Income</h2>
            <form id="income-form">
                <label class="mdc-text-field mdc-text-field--outlined" id="income-amount-mdc">
                    <span class="mdc-notched-outline"><span class="mdc-notched-outline__leading"></span><span class="mdc-notched-outline__notch"><label for="income-amount" class="mdc-floating-label">Amount</label></span><span class="mdc-notched-outline__trailing"></span></span>
                    <input type="number" id="income-amount" class="mdc-text-field__input" min="0.01" step="0.01" required>
                </label>
                <div class="mdc-select mdc-select--outlined" id="income-category-mdc">
                    <div class="mdc-select__anchor" role="button" aria-haspopup="listbox" aria-expanded="false">
                        <span class="mdc-notched-outline"><span class="mdc-notched-outline__leading"></span><span class="mdc-notched-outline__notch"><span class="mdc-floating-label">Category</span></span><span class="mdc-notched-outline__trailing"></span></span>
                        <span class="mdc-select__selected-text-container"><span class="mdc-select__selected-text"></span></span>
                        <span class="mdc-select__dropdown-icon"><svg class="mdc-select__dropdown-icon-graphic" viewBox="7 10 10 5" focusable="false"><polygon class="mdc-select__dropdown-icon-inactive" stroke="none" fill-rule="evenodd" points="7 10 12 15 17 10"></polygon><polygon class="mdc-select__dropdown-icon-active" stroke="none" fill-rule="evenodd" points="7 15 12 10 17 15"></polygon></svg></span>
                    </div>
                    <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                        <ul class="mdc-list" id="income-category-list" role="listbox"></ul>
                    </div>
                </div>
                <select id="income-category" required style="display: none;"></select>
                <button id="add-income-btn" class="mdc-button mdc-button--raised" form="income-form">
                    <span class="mdc-button__ripple"></span>
                    <span class="mdc-button__label">Add Income</span>
                </button>
            </form>
        </div>
        <div class="form-container">
            <h2 class="mdc-typography--headline6">Add Expense</h2>
            <form id="expense-form">
                <label class="mdc-text-field mdc-text-field--outlined" id="expense-amount-mdc">
                    <span class="mdc-notched-outline"><span class="mdc-notched-outline__leading"></span><span class="mdc-notched-outline__notch"><label for="expense-amount" class="mdc-floating-label">Amount</label></span><span class="mdc-notched-outline__trailing"></span></span>
                    <input type="number" id="expense-amount" class="mdc-text-field__input" min="0.01" step="0.01" required>
                </label>
                <div class="mdc-select mdc-select--outlined" id="expense-category-mdc">
                    <div class="mdc-select__anchor" role="button" aria-haspopup="listbox" aria-expanded="false">
                        <span class="mdc-notched-outline"><span class="mdc-notched-outline__leading"></span><span class="mdc-notched-outline__notch"><span class="mdc-floating-label">Category</span></span><span class="mdc-notched-outline__trailing"></span></span>
                        <span class="mdc-select__selected-text-container"><span class="mdc-select__selected-text"></span></span>
                        <span class="mdc-select__dropdown-icon"><svg class="mdc-select__dropdown-icon-graphic" viewBox="7 10 10 5" focusable="false"><polygon class="mdc-select__dropdown-icon-inactive" stroke="none" fill-rule="evenodd" points="7 10 12 15 17 10"></polygon><polygon class="mdc-select__dropdown-icon-active" stroke="none" fill-rule="evenodd" points="7 15 12 10 17 15"></polygon></svg></span>
                    </div>
                    <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                        <ul class="mdc-list" id="expense-category-list" role="listbox"></ul>
                    </div>
                </div>
                <select id="expense-category" required style="display: none;"></select>
                <button id="add-expense-btn" class="mdc-button mdc-button--raised" form="expense-form">
                    <span class="mdc-button__ripple"></span>
                    <span class="mdc-button__label">Add Expense</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Transactions List -->
    <h2 class="mdc-typography--headline6">Transactions</h2>
    <ul id="transaction-list" class="mdc-list mdc-list--two-line"></ul>
</div>

<script>
    const apiUrl = 'http://localhost:8080';

    const transactionList = document.getElementById('transaction-list');
    const incomeForm = document.getElementById('income-form');
    const expenseForm = document.getElementById('expense-form');
    const monthFilter = document.getElementById('month-filter');
    const yearFilter = document.getElementById('year-filter');
    const incomeCategorySelect = document.getElementById('income-category');
    const expenseCategorySelect = document.getElementById('expense-category');

    // This will hold our available dates from the server, e.g., { "2024": [5, 6, 7], "2023": [12] }
    let availableDates = {};

    // Helper to format currency
    const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    // Helper to format date
    const formatDate = (isoString) => new Date(isoString).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    // Function to populate category dropdowns
    async function populateCategories() {
        // Clear previous options
        document.getElementById('income-category-list').innerHTML = '';
        document.getElementById('expense-category-list').innerHTML = '';

        // Add a disabled, placeholder option to the hidden selects
        incomeCategorySelect.innerHTML = '<option value="" disabled selected></option>';
        expenseCategorySelect.innerHTML = '<option value="" disabled selected></option>';

        const response = await fetch(`${apiUrl}/categories`);
        const categories = await response.json();

        categories.income.forEach(cat => {
            incomeCategorySelect.add(new Option(cat, cat));
            const li = document.createElement('li');
            // Add an empty first item to serve as a placeholder in the MDC list
            if (document.getElementById('income-category-list').childElementCount === 0) {
                const placeholder = document.createElement('li');
                placeholder.className = 'mdc-list-item mdc-list-item--disabled';
                placeholder.innerHTML = `<span class="mdc-list-item__ripple"></span>`;
                document.getElementById('income-category-list').appendChild(placeholder);
            }
            li.className = 'mdc-list-item';
            li.setAttribute('role', 'option');
            li.dataset.value = cat;
            li.innerHTML = `<span class="mdc-list-item__ripple"></span><span class="mdc-list-item__text">${cat}</span>`;
            document.getElementById('income-category-list').appendChild(li);
        });
        categories.expenses.forEach(cat => {
            expenseCategorySelect.add(new Option(cat, cat));
            const li = document.createElement('li');
            // Add an empty first item to serve as a placeholder in the MDC list
            if (document.getElementById('expense-category-list').childElementCount === 0) {
                const placeholder = document.createElement('li');
                placeholder.className = 'mdc-list-item mdc-list-item--disabled';
                placeholder.innerHTML = `<span class="mdc-list-item__ripple"></span>`;
                document.getElementById('expense-category-list').appendChild(placeholder);
            }
            li.className = 'mdc-list-item';
            li.setAttribute('role', 'option');
            li.dataset.value = cat;
            li.innerHTML = `<span class="mdc-list-item__ripple"></span><span class="mdc-list-item__text">${cat}</span>`;
            document.getElementById('expense-category-list').appendChild(li);
        });
    }

    // Function to populate date filters based on available data
    async function populateDateFilters() {
        const response = await fetch(`${apiUrl}/transactions/dates`);
        availableDates = await response.json();

        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();

        const years = Object.keys(availableDates).sort((a, b) => b - a);
        const yearList = document.getElementById('year-list');
        yearFilter.innerHTML = '';
        yearList.innerHTML = '';
        years.forEach(year => {
            yearFilter.add(new Option(year, year));
            const li = document.createElement('li');
            li.className = 'mdc-list-item';
            li.dataset.value = year;
            li.innerHTML = `<span class="mdc-list-item__ripple"></span><span class="mdc-list-item__text">${year}</span>`;
            yearList.appendChild(li);
        });

        // If there's data for the current year, select it. Otherwise, select the most recent year.
        if (years.includes(String(currentYear))) {
            yearFilter.value = currentYear;
        }

        updateMonthFilter();

        // If there's data for the current month, select it.
        if (availableDates[yearFilter.value]?.includes(currentMonth + 1)) {
            monthFilter.value = currentMonth + 1;
        }
    }

    // Updates the month filter based on the selected year
    function updateMonthFilter() {
        const selectedYear = yearFilter.value;
        const monthsForYear = availableDates[selectedYear] || [];
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthList = document.getElementById('month-list');
        
        monthFilter.innerHTML = '';
        monthList.innerHTML = '';
        monthsForYear.forEach(monthNumber => {
            monthFilter.add(new Option(monthNames[monthNumber - 1], monthNumber));
            const li = document.createElement('li');
            li.className = 'mdc-list-item';
            li.dataset.value = monthNumber;
            li.innerHTML = `<span class="mdc-list-item__ripple"></span><span class="mdc-list-item__text">${monthNames[monthNumber - 1]}</span>`;
            monthList.appendChild(li);
        });
    }

    // Fetches all data and re-renders the entire UI
    async function refreshUI() {
        const selectedYear = yearFilter.value;
        const selectedMonth = monthFilter.value;
        const response = await fetch(`${apiUrl}/transactions?year=${selectedYear}&month=${selectedMonth}`);
        const transactions = await response.json();

        // Clear previous list
        transactionList.innerHTML = '';

        // Calculate totals using Array.reduce
        const totalIncome = transactions
            .filter(t => t.type === 'income')
            .reduce((sum, t) => sum + t.amount, 0);

        const totalExpenses = transactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);

        const balance = totalIncome - totalExpenses;

        // Update summary
        document.getElementById('total-income').textContent = formatCurrency(totalIncome);
        document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
        document.getElementById('balance').textContent = formatCurrency(balance);

        // Render transaction list
        transactions.forEach(t => {
            const li = document.createElement('li');
            li.className = t.type === 'income' ? 'income-item' : 'expense-item';
            li.classList.add('mdc-list-item');
            li.innerHTML = `
                <span class="mdc-list-item__text">
                    <span class="mdc-list-item__primary-text">${t.category}</span>
                    <span class="mdc-list-item__secondary-text">${formatDate(t.date)}</span>
                </span>
                <span class="mdc-list-item__meta amount">
                    <span class="amount-text">${t.type === 'expense' ? '-' : ''}${formatCurrency(t.amount)}</span>
                    <button class="mdc-icon-button material-icons delete-btn" data-id="${t.id}" title="Delete">delete</button>
                </span>
            `;
            transactionList.appendChild(li);
        });
    }

    // Generic function to handle adding a transaction
    async function addTransaction(event, type) {
        event.preventDefault();
        const amountInput = document.getElementById(`${type}-amount`);
        const categoryInput = document.getElementById(`${type}-category`);

        const amount = amountInput.value;
        const category = categoryInput.value;

        // Reset MDC text field error state
        const amountMdcComponent = mdc.textField.MDCTextField.attachTo(document.getElementById(`${type}-amount-mdc`));
        amountMdcComponent.valid = true;

        // Client-side validation for category
        if (!category) {
            alert('Please select a category.');
            return; // Stop the function
        }

        await fetch(`${apiUrl}/transactions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, amount, category, date: new Date().toISOString() }),
        });

        amountInput.value = '';
        // Reset MDC select to show placeholder
        const categoryMdcComponent = mdc.select.MDCSelect.attachTo(document.getElementById(`${type}-category-mdc`));
        categoryMdcComponent.selectedIndex = 0;

        await refreshUI();
    }

    // Event Listeners
    incomeForm.addEventListener('submit', (e) => addTransaction(e, 'income'));
    expenseForm.addEventListener('submit', (e) => addTransaction(e, 'expense'));

    // Event listener for deleting transactions (using event delegation)
    transactionList.addEventListener('click', async (event) => {
        if (event.target.classList.contains('delete-btn')) {
            const id = event.target.dataset.id;
            await fetch(`${apiUrl}/transactions/${id}`, { method: 'DELETE' });
            await refreshUI();
        }
    });

    // --- MDC Initialization ---
    const mdcSelects = {};
    const mdcTextFields = {};
    function initializeMDC() {
        document.querySelectorAll('.mdc-button').forEach(el => new mdc.ripple.MDCRipple(el));
        document.querySelectorAll('.mdc-text-field').forEach(el => new mdc.textField.MDCTextField(el));
        document.querySelectorAll('.mdc-select').forEach(el => {
            const select = new mdc.select.MDCSelect(el);
            mdcSelects[el.id] = select;
            const hiddenSelectId = el.id.replace('-mdc', '');
            const hiddenSelect = document.getElementById(hiddenSelectId);
            if (hiddenSelect) {
                select.listen('MDCSelect:change', () => {
                    hiddenSelect.value = select.value;
                    // Manually dispatch change event for our logic
                    hiddenSelect.dispatchEvent(new Event('change'));
                });
            }
        });
    }

    // --- App Initialization ---
    async function initializeApp() {
        initializeMDC();
        await Promise.all([populateCategories(), populateDateFilters()]);
        
        // Set initial values for MDC selects
        mdcSelects['year-filter-mdc'].value = yearFilter.value;
        mdcSelects['month-filter-mdc'].value = monthFilter.value;

        // Add listeners after population
        yearFilter.addEventListener('change', () => { updateMonthFilter(); mdcSelects['month-filter-mdc'].value = monthFilter.value; refreshUI(); });
        monthFilter.addEventListener('change', refreshUI);

        refreshUI();
    }
    initializeApp();
</script>
</body>
</html>
