<!-- index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
    <title>Family Budget Tracker</title>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Family Budget Tracker</h1>
        <a href="/categories.html" style="font-size: 0.9em;">Manage Categories</a>
    </div>

    

    <!-- Summary Section -->
    <div class="summary">
        <div>
            <h3>Total Income</h3>
            <span id="total-income" class="amount">$0.00</span>
        </div>
        <div>
            <h3>Total Expenses</h3>
            <span id="total-expenses" class="amount">$0.00</span>
        </div>
        <div>
            <h3>Balance</h3>
            <span id="balance" class="amount">$0.00</span>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filters">
        <label for="month-filter">Filter by:</label>
        <select id="month-filter"></select>
        <select id="year-filter"></select>
    </div>

    <!-- Forms Section -->
    <div class="forms">
        <div class="form-container">
            <h2>Add Income</h2>
            <form id="income-form">
                <input type="number" id="income-amount" placeholder="Amount" min="0.01" step="0.01" required>
                <select id="income-category" required></select>
                <button id="add-income-btn" type="submit">Add Income</button>
            </form>
        </div>
        <div class="form-container">
            <h2>Add Expense</h2>
            <form id="expense-form">
                <input type="number" id="expense-amount" placeholder="Amount" min="0.01" step="0.01" required>
                <select id="expense-category" required></select>
                <button id="add-expense-btn" type="submit">Add Expense</button>
            </form>
        </div>
    </div>

    <!-- Transactions List -->
    <h2>Transactions</h2>
    <ul id="transaction-list"></ul>
</div>

<script>
    // In a real cloud environment, you might get this URL dynamically.
    // For Cloud Shell's Web Preview, this will be automatically handled.
    const apiUrl = 'http://localhost:8080';

    const transactionList = document.getElementById('transaction-list');
    const incomeForm = document.getElementById('income-form');
    const incomeCategorySelect = document.getElementById('income-category');
    const expenseForm = document.getElementById('expense-form');
    const expenseCategorySelect = document.getElementById('expense-category');
    const monthFilter = document.getElementById('month-filter');
    const yearFilter = document.getElementById('year-filter');

    // This will hold our available dates from the server, e.g., { "2024": [5, 6, 7], "2023": [12] }
    let availableDates = {};

    // Helper to format currency
    const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    // Helper to format date
    const formatDate = (isoString) => new Date(isoString).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    // Function to populate category dropdowns
    async function populateCategories() {
        const response = await fetch(`${apiUrl}/categories`);
        const categories = await response.json();
        categories.income.forEach(cat => {
            const option = new Option(cat, cat);
            incomeCategorySelect.add(option);
        });
        categories.expenses.forEach(cat => {
            const option = new Option(cat, cat);
            expenseCategorySelect.add(option);
        });
    }

    // Function to populate date filters based on available data
    async function populateDateFilters() {
        const response = await fetch(`${apiUrl}/transactions/dates`);
        availableDates = await response.json();

        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();

        const years = Object.keys(availableDates).sort((a, b) => b - a);
        yearFilter.innerHTML = '';
        years.forEach(year => {
            const option = new Option(year, year);
            yearFilter.add(option);
        });

        // If there's data for the current year, select it. Otherwise, select the most recent year.
        if (years.includes(String(currentYear))) {
            yearFilter.value = currentYear;
        }

        updateMonthFilter();

        // If there's data for the current month, select it.
        if (availableDates[yearFilter.value]?.includes(currentMonth + 1)) {
            monthFilter.value = currentMonth + 1;
        }
    }

    // Updates the month filter based on the selected year
    function updateMonthFilter() {
        const selectedYear = yearFilter.value;
        const monthsForYear = availableDates[selectedYear] || [];
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        monthFilter.innerHTML = '';
        monthsForYear.forEach(monthNumber => {
            const option = new Option(monthNames[monthNumber - 1], monthNumber);
            monthFilter.add(option);
        });
    }

    // Fetches all data and re-renders the entire UI
    async function refreshUI() {
        const selectedYear = yearFilter.value;
        const selectedMonth = monthFilter.value;
        const response = await fetch(`${apiUrl}/transactions?year=${selectedYear}&month=${selectedMonth}`);
        const transactions = await response.json();

        // Clear previous list
        transactionList.innerHTML = '';

        // Calculate totals using Array.reduce
        const totalIncome = transactions
            .filter(t => t.type === 'income')
            .reduce((sum, t) => sum + t.amount, 0);

        const totalExpenses = transactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);

        const balance = totalIncome - totalExpenses;

        // Update summary
        document.getElementById('total-income').textContent = formatCurrency(totalIncome);
        document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
        document.getElementById('balance').textContent = formatCurrency(balance);

        // Render transaction list
        transactions.forEach(t => {
            const li = document.createElement('li');
            li.className = t.type === 'income' ? 'income-item' : 'expense-item';
            li.innerHTML = `
                <span class="date">${formatDate(t.date)}</span>
                <span class="category">${t.category}</span>
                <span class="amount">${t.type === 'expense' ? '-' : ''}${formatCurrency(t.amount)}
                    <button class="delete-btn" data-id="${t.id}">X</button>
                </span>
            `;
            transactionList.appendChild(li);
        });
    }

    // Generic function to handle adding a transaction
    async function addTransaction(event, type) {
        event.preventDefault();
        const amountInput = document.getElementById(`${type}-amount`);
        const categoryInput = document.getElementById(`${type}-category`);

        const amount = amountInput.value;
        const category = categoryInput.value;

        await fetch(`${apiUrl}/transactions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, amount, category }),
        });

        amountInput.value = '';
        await refreshUI();
    }

    // Event Listeners
    incomeForm.addEventListener('submit', (e) => addTransaction(e, 'income'));
    expenseForm.addEventListener('submit', (e) => addTransaction(e, 'expense'));
    monthFilter.addEventListener('change', refreshUI);
    yearFilter.addEventListener('change', () => {
        updateMonthFilter();
        refreshUI();
    });

    // Event listener for deleting transactions (using event delegation)
    transactionList.addEventListener('click', async (event) => {
        if (event.target.classList.contains('delete-btn')) {
            const id = event.target.dataset.id;
            await fetch(`${apiUrl}/transactions/${id}`, { method: 'DELETE' });
            await refreshUI();
        }
    });

    // Initial load sequence
    async function initializeApp() {
        await Promise.all([populateCategories(), populateDateFilters()]);
        refreshUI();
    }
    initializeApp();
</script>
</body>
</html>
