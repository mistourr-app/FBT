<!-- index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Family Budget Tracker</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        .summary { display: flex; justify-content: space-around; background: #f7f7f7; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .summary div { flex: 1; }
        .summary h3 { margin: 0 0 5px 0; font-size: 1em; color: #666; }
        .summary .amount { font-size: 1.5em; font-weight: 600; }
        #total-income { color: #2ecc71; }
        #total-expenses { color: #e74c3c; }
        #balance { color: #3498db; }
        .forms { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-container { flex: 1; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        input[type="text"], input[type="number"], select { width: 100%; box-sizing: border-box; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; padding: 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 1em; }
        #add-income-btn { background-color: #2ecc71; }
        #add-expense-btn { background-color: #e74c3c; }
        #transaction-list { list-style-type: none; padding: 0; }
        #transaction-list li { display: grid; grid-template-columns: auto 1fr auto; gap: 15px; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        #transaction-list li:last-child { border-bottom: none; }
        .date { font-size: 0.8em; color: #888; width: 80px; }
        .category { font-size: 0.8em; padding: 3px 8px; background-color: #eee; border-radius: 10px; text-align: center; }
        .expense-item .amount { color: #e74c3c; }
        .income-item .amount { color: #2ecc71; }
        .delete-btn { background: #95a5a6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .filters { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Family Budget Tracker</h1>
        <a href="/categories.html" style="font-size: 0.9em;">Manage Categories</a>
    </div>

    

    <!-- Summary Section -->
    <div class="summary">
        <div>
            <h3>Total Income</h3>
            <span id="total-income" class="amount">$0.00</span>
        </div>
        <div>
            <h3>Total Expenses</h3>
            <span id="total-expenses" class="amount">$0.00</span>
        </div>
        <div>
            <h3>Balance</h3>
            <span id="balance" class="amount">$0.00</span>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filters">
        <label for="month-filter">Filter by:</label>
        <select id="month-filter"></select>
        <select id="year-filter"></select>
    </div>

    <!-- Forms Section -->
    <div class="forms">
        <div class="form-container">
            <h2>Add Income</h2>
            <form id="income-form">
                <input type="number" id="income-amount" placeholder="Amount" min="0.01" step="0.01" required>
                <select id="income-category" required></select>
                <button id="add-income-btn" type="submit">Add Income</button>
            </form>
        </div>
        <div class="form-container">
            <h2>Add Expense</h2>
            <form id="expense-form">
                <input type="number" id="expense-amount" placeholder="Amount" min="0.01" step="0.01" required>
                <select id="expense-category" required></select>
                <button id="add-expense-btn" type="submit">Add Expense</button>
            </form>
        </div>
    </div>

    <!-- Transactions List -->
    <h2>Transactions</h2>
    <ul id="transaction-list"></ul>
</div>

<script>
    // In a real cloud environment, you might get this URL dynamically.
    // For Cloud Shell's Web Preview, this will be automatically handled.
    const apiUrl = 'http://localhost:8080';

    const transactionList = document.getElementById('transaction-list');
    const incomeForm = document.getElementById('income-form');
    const incomeCategorySelect = document.getElementById('income-category');
    const expenseForm = document.getElementById('expense-form');
    const expenseCategorySelect = document.getElementById('expense-category');
    const monthFilter = document.getElementById('month-filter');
    const yearFilter = document.getElementById('year-filter');

    // Helper to format currency
    const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    // Helper to format date
    const formatDate = (isoString) => new Date(isoString).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    // Function to populate category dropdowns
    async function populateCategories() {
        const response = await fetch(`${apiUrl}/categories`);
        const categories = await response.json();
        categories.income.forEach(cat => {
            const option = new Option(cat, cat);
            incomeCategorySelect.add(option);
        });
        categories.expenses.forEach(cat => {
            const option = new Option(cat, cat);
            expenseCategorySelect.add(option);
        });
    }

    // Function to populate date filters
    function populateDateFilters() {
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();

        // Populate years (e.g., last 5 years)
        for (let i = 0; i < 5; i++) {
            const year = currentYear - i;
            const option = new Option(year, year);
            yearFilter.add(option);
        }

        // Populate months
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        monthNames.forEach((name, index) => {
            const option = new Option(name, index + 1);
            monthFilter.add(option);
        });

        // Set default to current month and year
        monthFilter.value = currentMonth + 1;
        yearFilter.value = currentYear;
    }

    // Fetches all data and re-renders the entire UI
    async function refreshUI() {
        const selectedYear = yearFilter.value;
        const selectedMonth = monthFilter.value;
        const response = await fetch(`${apiUrl}/transactions?year=${selectedYear}&month=${selectedMonth}`);
        const transactions = await response.json();

        // Clear previous list
        transactionList.innerHTML = '';

        // Calculate totals using Array.reduce
        const totalIncome = transactions
            .filter(t => t.type === 'income')
            .reduce((sum, t) => sum + t.amount, 0);

        const totalExpenses = transactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);

        const balance = totalIncome - totalExpenses;

        // Update summary
        document.getElementById('total-income').textContent = formatCurrency(totalIncome);
        document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
        document.getElementById('balance').textContent = formatCurrency(balance);

        // Render transaction list
        transactions.forEach(t => {
            const li = document.createElement('li');
            li.className = t.type === 'income' ? 'income-item' : 'expense-item';
            li.innerHTML = `
                <span class="date">${formatDate(t.date)}</span>
                <span class="category">${t.category}</span>
                <span class="amount">${t.type === 'expense' ? '-' : ''}${formatCurrency(t.amount)}
                    <button class="delete-btn" data-id="${t.id}">X</button>
                </span>
            `;
            transactionList.appendChild(li);
        });
    }

    // Generic function to handle adding a transaction
    async function addTransaction(event, type) {
        event.preventDefault();
        const amountInput = document.getElementById(`${type}-amount`);
        const categoryInput = document.getElementById(`${type}-category`);

        const amount = amountInput.value;
        const category = categoryInput.value;

        await fetch(`${apiUrl}/transactions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, amount, category }),
        });

        amountInput.value = '';
        await refreshUI();
    }

    // Event Listeners
    incomeForm.addEventListener('submit', (e) => addTransaction(e, 'income'));
    expenseForm.addEventListener('submit', (e) => addTransaction(e, 'expense'));
    monthFilter.addEventListener('change', refreshUI);
    yearFilter.addEventListener('change', refreshUI);

    // Event listener for deleting transactions (using event delegation)
    transactionList.addEventListener('click', async (event) => {
        if (event.target.classList.contains('delete-btn')) {
            const id = event.target.dataset.id;
            await fetch(`${apiUrl}/transactions/${id}`, { method: 'DELETE' });
            await refreshUI();
        }
    });

    // Initial load
    populateCategories();
    populateDateFilters();
    refreshUI();
</script>
</body>
</html>
