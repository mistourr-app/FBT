<!-- index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Material Design CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Material Design Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- App Stylesheet -->
    <link rel="stylesheet" href="styles.css">
    <title>Family Budget Tracker</title>
</head>
<body class="mdc-typography">

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Budget Tracker</h1>
        <a href="/categories.html" class="mdc-button">
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label">Manage Categories</span>
        </a>
    </div>


    <!-- Summary Section -->
    <div class="summary">
        <div>
            <h3>Total Income</h3>
            <span id="total-income" class="amount">$0.00</span>
        </div>
        <div>
            <h3>Total Expenses</h3>
            <span id="total-expenses" class="amount">$0.00</span>
        </div>
        <div>
            <h3>Balance</h3>
            <span id="balance" class="amount">$0.00</span>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filters mdc-menu-surface--anchor" style="display: flex; justify-content: center; align-items: center; gap: 8px;">
        <button class="mdc-button mdc-button--outlined" id="date-filter-button">
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label">Select Period</span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_drop_down</i>
        </button>
        <button class="mdc-icon-button material-icons" id="reset-date-filter-button" title="Reset to default" hidden>
            <div class="mdc-icon-button__ripple"></div>
            refresh
        </button>
        <div class="mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth" id="date-filter-menu">
            <ul class="mdc-list" role="menu" aria-hidden="true" aria-orientation="vertical" tabindex="-1">
                <!-- Items will be populated by JavaScript -->
            </div>
        </div>

    <div class="forms">
    <div class="form-container">
        <h2>Add Income</h2>
        <form id="income-form" class="transaction-form">
            <input type="number" id="income-amount" placeholder="Amount" min="0.01" step="0.01" required>
            <select id="income-category" required>
                <option value="" disabled selected>Select category</option>
            </select>
            <button id="add-income-btn" type="submit">Add Income</button>
        </form>
    </div>
    <div class="form-container">
        <h2>Add Expense</h2>
        <form id="expense-form" class="transaction-form">
            <input type="number" id="expense-amount" placeholder="Amount" min="0.01" step="0.01" required>
            <select id="expense-category" required>
                <option value="" disabled selected>Select category</option>
            </select>
            <button id="add-expense-btn" type="submit">Add Expense</button>
        </form>
    </div>
</div>
    <!-- Transactions List -->
    <h2>Transactions</h2>
    <ul id="transaction-list" class="mdc-list mdc-list--two-line"></ul>  
</div>

<script>
    const apiUrl = ''; // Use relative paths for API calls

    const transactionList = document.getElementById('transaction-list');
    const incomeForm = document.getElementById('income-form');
    const expenseForm = document.getElementById('expense-form');
    const incomeCategorySelect = document.getElementById('income-category');
    const expenseCategorySelect = document.getElementById('expense-category');

    // This will hold our available dates from the server, e.g., { "2024": [5, 6, 7], "2023": [12] }
    let availableDates = {};

    // State for the new date filter
    let selectedYear;
    let selectedMonth;
    let dateFilterMenu;
    let defaultYear;
    let defaultMonth;
    let resetButton;

    // Helper to format currency
    const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    // Helper to format date
    const formatDate = (isoString) => new Date(isoString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

    // Function to populate category dropdowns
    async function populateCategories() {
        incomeCategorySelect.innerHTML = '<option value="" disabled selected>Select category</option>';
        expenseCategorySelect.innerHTML = '<option value="" disabled selected>Select category</option>';

        try {
            const response = await fetch(`${apiUrl}/categories`);
            if (!response.ok) throw new Error('Failed to fetch categories');
            const categories = await response.json();

            categories.income.forEach(cat => {
                incomeCategorySelect.add(new Option(cat, cat));
            });
            categories.expenses.forEach(cat => {
                expenseCategorySelect.add(new Option(cat, cat));
            });
        } catch (error) {
            console.error('Error populating categories:', error);
            alert('Could not load categories. Please try again later.');
        }
    }

    // Function to populate the new date filter menu
    async function populateDateFilterMenu() {
        const response = await fetch(`${apiUrl}/transactions/dates`);
        availableDates = await response.json();
        const menuList = document.querySelector('#date-filter-menu .mdc-list');
        menuList.innerHTML = ''; // Clear existing items

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const years = Object.keys(availableDates).sort((a, b) => b - a);

        const today = new Date();
        let hasSetDefault = false;

        years.forEach(year => {
            // Add clickable year item
            const yearItem = document.createElement('li');
            yearItem.className = 'mdc-list-item year-item'; // Custom class for styling
            yearItem.setAttribute('role', 'menuitem');
            yearItem.dataset.year = year;
            yearItem.innerHTML = `<span class="mdc-list-item__ripple"></span><span class="mdc-list-item__text">${year}</span>`;
            menuList.appendChild(yearItem);

            const months = availableDates[year];
            months.forEach(month => {
                const li = document.createElement('li');
                li.className = 'mdc-list-item month-item'; // Custom class for styling
                li.setAttribute('role', 'menuitem');
                li.dataset.year = year;
                li.dataset.month = month;
                li.innerHTML = `<span class="mdc-list-item__ripple"></span><span class="mdc-list-item__text">${monthNames[month - 1]}</span>`;
                menuList.appendChild(li);
            });

            // Add a divider after each year group except the last one
            if (years.indexOf(year) < years.length - 1) {
                const divider = document.createElement('li');
                divider.className = 'mdc-list-divider';
                divider.setAttribute('role', 'separator');
                menuList.appendChild(divider);
            }
        });

        // The default view is always the current month and year.
        const currentYear = String(today.getFullYear());
        const currentMonth = String(today.getMonth() + 1);
        defaultYear = currentYear;
        defaultMonth = currentMonth;

        // Set the initial view to the default (current month and year).
        await setSelectedDate(defaultYear, defaultMonth);
    }

    // Fetches all data and re-renders the entire UI
    async function refreshUI() {

        try {
            const response = await fetch(`${apiUrl}/transactions?year=${selectedYear}&month=${selectedMonth}`);
            if (!response.ok) throw new Error('Failed to fetch transactions');
            const transactions = await response.json();

            // Clear previous list
            transactionList.innerHTML = '';

            // Calculate totals using Array.reduce
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const balance = totalIncome - totalExpenses;

            // Update summary
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('balance').textContent = formatCurrency(balance);

            // Render transaction list
            transactions.forEach(t => {
                const li = document.createElement('li');
                li.className = t.type === 'income' ? 'income-item' : 'expense-item';
                li.classList.add('mdc-list-item');
                li.innerHTML = `
                    <span class="mdc-list-item__text">
                        <span class="mdc-list-item__primary-text">${t.category}</span>
                        <span class="mdc-list-item__secondary-text">${formatDate(t.date)}</span>
                    </span>
                    <span class="mdc-list-item__meta amount">
                        <span class="amount-text">${t.type === 'expense' ? '-' : ''}${formatCurrency(t.amount)}</span>
                        <button class="mdc-icon-button material-icons delete-btn" data-id="${t.id}" title="Delete">delete</button>
                    </span>
                `;
                transactionList.appendChild(li);
            });
        } catch (error) {
            console.error('Error refreshing UI:', error);
            alert('Could not load transaction data. Please try again later.');
        }
    }

    async function setSelectedDate(year, month) {
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const buttonLabel = document.querySelector('#date-filter-button .mdc-button__label');

        selectedYear = year;
        selectedMonth = month;

        // If a month is provided, show "Month Year", otherwise just "Year"
        buttonLabel.textContent = month ? `${monthNames[month - 1]} ${year}` : year;

        // Show or hide the reset button
        const isDefault = String(year) === String(defaultYear) && String(month) === String(defaultMonth);
        await refreshUI();
        resetButton.hidden = isDefault;
    }

    // Generic function to handle adding a transaction
    async function addTransaction(event, type) {
        event.preventDefault();
        const amountInput = document.getElementById(`${type}-amount`);
        const categoryInput = document.getElementById(`${type}-category`);

        const amount = amountInput.value;
        const category = categoryInput.value;

        if (!category) {
            alert('Please select a category.');
            return; // Stop the function
        }

        try {
            const response = await fetch(`${apiUrl}/transactions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, amount, category, date: new Date().toISOString() }),
            });
            if (!response.ok) throw new Error('Failed to add transaction');
        } catch (error) {
            console.error('Error adding transaction:', error);
            alert('Could not add transaction. Please try again.');
        }
        amountInput.value = '';
        categoryInput.value = '';

        await refreshUI();
    }

    // Event Listeners
    incomeForm.addEventListener('submit', (e) => addTransaction(e, 'income'));
    expenseForm.addEventListener('submit', (e) => addTransaction(e, 'expense'));

    // Event listener for deleting transactions (using event delegation)
    transactionList.addEventListener('click', async (event) => {
        if (event.target.classList.contains('delete-btn')) {
            const id = event.target.dataset.id;
            if (confirm('Are you sure you want to delete this transaction?')) {
                try {
                    await fetch(`${apiUrl}/transactions/${id}`, { method: 'DELETE' });
                    await refreshUI();
                } catch (error) {
                    alert('Error deleting transaction.');
                }
            }
        }
    });

    // --- MDC Initialization ---
    function initializeMDC() {
        document.querySelectorAll('.mdc-button').forEach(el => new mdc.ripple.MDCRipple(el));
        document.querySelectorAll('.mdc-icon-button').forEach(el => new mdc.ripple.MDCRipple(el));

        // Initialize Date Filter Menu
        const menuEl = document.getElementById('date-filter-menu');
        dateFilterMenu = new mdc.menu.MDCMenu(menuEl);

        const dateFilterButton = document.getElementById('date-filter-button');
        dateFilterButton.addEventListener('click', () => {
            dateFilterMenu.open = !dateFilterMenu.open;
        });

        menuEl.addEventListener('MDCMenu:selected', async (event) => {
            const { year, month } = event.detail.item.dataset; // month will be undefined for year items
            await setSelectedDate(year, month);
        });

        resetButton = document.getElementById('reset-date-filter-button');
        resetButton.addEventListener('click', async () => {
            await setSelectedDate(defaultYear, defaultMonth);
        });
    }

    // --- App Initialization ---
    async function initializeApp() {
        initializeMDC();
        await populateCategories();
        await populateDateFilterMenu();
        // refreshUI is called by setSelectedDate inside populateDateFilterMenu
    }
    initializeApp();
</script>
</body>
</html>
