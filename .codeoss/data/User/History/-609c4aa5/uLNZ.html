<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Material Design CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <title>Manage Categories</title>
</head>
<body class="mdc-typography">

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Manage Categories</h1>
        <a href="/" class="mdc-button">
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label">Back to Tracker</span>
        </a>
    </div>

    <div class="category-manager">
        <!-- Income Categories Section -->
        <div class="category-section">
            <h2>Income Categories</h2>
            <ul id="income-list"></ul>
            <form id="add-income-form" class="add-form">
                <input type="text" id="new-income-category" placeholder="New income category" required>
                <button type="submit" title="Add Category"><i class="fas fa-plus"></i></button>
            </form>
        </div>

        <!-- Expense Categories Section -->
        <div class="category-section">
            <h2>Expense Categories</h2>
            <ul id="expense-list"></ul>
            <form id="add-expense-form" class="add-form">
                <input type="text" id="new-expense-category" placeholder="New expense category" required>
                <button type="submit" title="Add Category"><i class="fas fa-plus"></i></button>
            </form>
        </div>
    </div>
</div>

<!-- MDC Dialog for Renaming -->
<div class="mdc-dialog" id="rename-dialog">
    <div class="mdc-dialog__container">
        <div class="mdc-dialog__surface"
             role="alertdialog"
             aria-modal="true"
             aria-labelledby="rename-dialog-title"
             aria-describedby="rename-dialog-content">
            <h2 class="mdc-dialog__title" id="rename-dialog-title">Rename Category</h2>
            <div class="mdc-dialog__content" id="rename-dialog-content">
                <div class="mdc-text-field mdc-text-field--outlined" id="rename-field-mdc" style="width: 100%;">
                    <input type="text" id="rename-input" class="mdc-text-field__input">
                    <div class="mdc-notched-outline">
                        <div class="mdc-notched-outline__leading"></div>
                        <div class="mdc-notched-outline__notch">
                            <label for="rename-input" class="mdc-floating-label">New Name</label>
                        </div>
                        <div class="mdc-notched-outline__trailing"></div>
                    </div>
                </div>
            </div>
            <div class="mdc-dialog__actions">
                <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="cancel">
                    <span class="mdc-button__label">Cancel</span>
                </button>
                <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="accept" id="rename-accept-btn">
                    <span class="mdc-button__label">Rename</span>
                </button>
            </div>
        </div>
    </div>
    <div class="mdc-dialog__scrim"></div>
</div>

<script>
    const apiUrl = ''; // Use relative paths for API calls
    const incomeList = document.getElementById('income-list');
    const expenseList = document.getElementById('expense-list');
    let renameDialog, renameTextField;
    let categoryToRename = {};

    // Function to render a list of categories
    function renderCategoryList(listElement, categories, type) {
        listElement.innerHTML = '';
        categories.forEach(cat => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${cat}</span>
                <div class="controls">
                    <button class="rename-btn" data-type="${type}" data-name="${cat}" title="Rename"><i class="fas fa-pencil-alt"></i></button>
                    <button class="delete-btn" data-type="${type}" data-name="${cat}" title="Delete"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
            listElement.appendChild(li);
        });
    }

    // Fetch and render all categories
    async function fetchAndRenderCategories() {
        const response = await fetch(`${apiUrl}/categories`);
        if (response.ok) {
            const data = await response.json();
            renderCategoryList(incomeList, data.income, 'income');
            renderCategoryList(expenseList, data.expenses, 'expense');
        } else {
            alert('Error: Could not fetch categories.');
        }
    }

    // Handle adding a new category
    async function addCategory(event, type) {
        event.preventDefault();
        const input = document.getElementById(`new-${type}-category`);
        const name = input.value.trim();
        if (!name) return;

        try {
            await fetch(`${apiUrl}/categories`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, name }),
            });
        } catch (error) {
            alert(`Error adding category: ${error}`);
            return;
        }
        
        input.value = '';
        await fetchAndRenderCategories();
    }

    // Handle renaming a category
    async function renameCategory(type, oldName) {
        // Store the category info and open the dialog
        categoryToRename = { type, oldName };
        renameTextField.value = oldName;
        // We need to re-layout the text field label
        renameTextField.layout();
        renameDialog.open();
        document.getElementById('rename-input').focus();
    }

    // Handle deleting a category
    async function deleteCategory(type, name) {
        if (!confirm(`Are you sure you want to delete the category "${name}"?`)) return;

        try {
            const response = await fetch(`${apiUrl}/categories`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, name }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Server error');
            }
            await fetchAndRenderCategories();
        } catch (error) {
            alert(`Error deleting category: ${error.message}`);
        }
    }

    // Event Listeners
    document.getElementById('add-income-form').addEventListener('submit', (e) => addCategory(e, 'income'));
    document.getElementById('add-expense-form').addEventListener('submit', (e) => addCategory(e, 'expense'));

    // Use event delegation for rename and delete buttons on the category manager
    document.querySelector('.category-manager').addEventListener('click', (event) => {
        const button = event.target.closest('button');
        if (!button) return;

        const { type, name } = button.dataset;

        if (button.classList.contains('rename-btn')) {
            renameCategory(type, name);
        } else if (button.classList.contains('delete-btn')) {
            deleteCategory(type, name);
        }
    });

    // --- App Initialization ---
    function initializeApp() {
        // Initialize standard MDC components
        document.querySelectorAll('.mdc-button').forEach(el => new mdc.ripple.MDCRipple(el));

        // Initialize Dialog
        const dialogElement = document.getElementById('rename-dialog');
        renameDialog = new mdc.dialog.MDCDialog(dialogElement);
        renameTextField = new mdc.textField.MDCTextField(document.getElementById('rename-field-mdc'));

        // Add listener for when the dialog closes
        renameDialog.listen('MDCDialog:closing', async (event) => {
            if (event.detail.action === 'accept') {
                const newName = renameTextField.value.trim();
                const { type, oldName } = categoryToRename;

                if (!newName || newName === oldName) return;

                try {
                    await fetch(`${apiUrl}/categories`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type, oldName, newName }),
                    });
                    await fetchAndRenderCategories();
                } catch (error) {
                    alert(`Error renaming category: ${error}`);
                }
            }
        });

        fetchAndRenderCategories();
    }
    initializeApp();
</script>

</body>
</html>